language: rust
rust: stable
services: docker

env:
  global:
    - CRATE_NAME=ddns-cli
    - DISABLE_TESTS=1
    - RUST_BACKTRACE=1
    - LANG="zh_CN.UTF-8"
    - USING_CROSS=0
    - USING_TRUST=0
    - USING_SYSTEM_ALLOC=0
    - PKG_CONFIG_ALL_STATIC=1

matrix:
  include:
    # OSX
    #- os: osx
    #  env: USING_TRUST=1 TARGET=i686-apple-darwin
    - os: osx
      env: USING_SYSTEM_ALLOC=0 USING_CROSS=0 TARGET=x86_64-apple-darwin
    # ios
    # - env: USING_TRUST=1 TARGET=aarch64-apple-ios
    #   os: osx
    # - env: USING_TRUST=1 TARGET=armv7-apple-ios
    #   os: osx
    # - env: USING_TRUST=1 TARGET=armv7s-apple-ios
    #   os: osx
    # - env: USING_TRUST=1 TARGET=i386-apple-ios
    #   os: osx
    # - env: USING_TRUST=1 TARGET=x86_64-apple-ios
    #   os: osx
    # linux
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=1 USING_CROSS=1 TARGET=aarch64-unknown-linux-gnu
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=1 USING_CROSS=1 TARGET=arm-unknown-linux-gnueabi
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=1 USING_CROSS=1 TARGET=armv7-unknown-linux-gnueabihf
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=0 USING_CROSS=1 TARGET=i686-unknown-linux-gnu
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=mips-unknown-linux-gnu
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=mipsel-unknown-linux-gnu
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=mips64-unknown-linux-gnuabi64
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=mips64el-unknown-linux-gnuabi64
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=powerpc-unknown-linux-gnu
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=powerpc64-unknown-linux-gnu
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=powerpc64le-unknown-linux-gnu
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=0 USING_CROSS=0 TARGET=x86_64-unknown-linux-gnu
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=aarch64-unknown-linux-musl
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=arm-unknown-linux-musleabihf
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=arm-unknown-linux-musleabi
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=armv7-unknown-linux-musleabihf
    # linux-musl
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=0 USING_CROSS=1 TARGET=i686-unknown-linux-musl
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=mips-unknown-linux-musl
    # - os: linux
    #   dist: xenial
    #   sudo: required
    #   env: USING_TRUST=1 TARGET=mipsel-unknown-linux-musl
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=0 USING_CROSS=1 TARGET=x86_64-unknown-linux-musl
    # Android
    - os: linux
      dist: xenial
      sudo: required
      env: USING_TRUST=1 TARGET=aarch64-linux-android
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=1 USING_CROSS=1 TARGET=arm-linux-androideabi
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=1 USING_CROSS=1 TARGET=armv7-linux-androideabi
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=1 USING_CROSS=1 TARGET=i686-linux-android
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=1 USING_CROSS=1 TARGET=x86_64-linux-android
    # BSD
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=0 USING_CROSS=1 TARGET=x86_64-unknown-netbsd
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=0 USING_CROSS=1 TARGET=x86_64-unknown-freebsd
    # Solaris
    - os: linux
      dist: xenial
      sudo: required
      env: USING_SYSTEM_ALLOC=0 USING_CROSS=1 TARGET=x86_64-sun-solaris
    ## Windows
    # - env: TARGET=x86_64-pc-windows-gnu

before_install:
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then ulimit -a; sysctl -a; sudo apt-get -qq update; fi
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then brew update; fi
  - rustup self update;
  - rustup update --force stable;
  - if [ $USING_TRUST -ne 0 ]; then

    set -e ;

    elif [ $USING_CROSS -ne 0 ]; then

    cargo install xargo --force;

    cargo install cross --force;

    else

    rustup target add $TARGET ;

    rustup toolchain install stable-$TARGET ;

    fi

install:
  - if [ $USING_TRUST -ne 0 ]; then

    bash ci/install.sh ;

    source ~/.cargo/env || true ;

    fi

script:
  - if [ $USING_SYSTEM_ALLOC -eq 0 ]; then

    BUILD_WITH_SYSTEM_ALLOC="";

    else

    BUILD_WITH_SYSTEM_ALLOC=" --features system-alloc";

    fi
  - if [ $USING_TRUST -ne 0 ]; then

    bash ci/script.sh ;

    elif [ $USING_CROSS -ne 0 ]; then

    cross build --target $TARGET --release $BUILD_WITH_SYSTEM_ALLOC ;

    else

    env PKG_CONFIG_ALL_STATIC=1 cargo build --release --target $TARGET $BUILD_WITH_SYSTEM_ALLOC ;

    fi

    cd "target/$TARGET/release/";

    mkdir -p bin;

    if [ -e ddns-cli ]; then

    cp -f ddns-cli bin/ddns-cli;

    else

    cp -f ddns-cli* bin/;

    fi

    tar -zcvf $TARGET.tar.gz bin;

    cd ../../..;

    mv -f "target/$TARGET/release/$TARGET.tar.gz" ./;

cache: cargo

deploy:
  provider: releases
  api_key:
    secure: kEV+KpMWw+2SACmiGx21/fLKaTh98GbJXUTYNh2pIJ0bU3a69QxPjukcoXK8irYET6rRxW2paLRWuXo+5t9S3yCrXHS4t8IcH+MZOkZBqL1VJGmEQcgeyaKfDwECnUGJTVejJkZsgN3p5gbOFq3s5Gbp1DkAfLSW5v640dfDxq1CFsiLv5sR33VHuTb0u5fAc2fCQKxKoHKgQ2qveubaOH3IWTjoy/hOS566SH0oAs98kPbMd23UQ90J2B80Ee3lUP9dv7BK3w9mVi019XO1bl2CZmr/MoE4ZM1BtMbFqRYNh0Pdee6Bvn/lJqtRzjyrir5wMipVAi55IKr2pa5JTZdNp1Q51Re7OUFsjhZkX+YektMl/mYolq1SfMQzPQ1GYaTMbGh7t6GTOFCgHkb+VadlmoSG3FaVvg8m3Ox6NJ4okuF4eMj/kmyomCQoQHioPn/9Tfnq8BiPiTq6Azh+ukQpYlMH13chw7rAr9rLqOhlZ8xI66g07AT+DeUNa6iNGkr490yJ02t6uP0lvusDN6DBVDoAb+EKSGJgKRD4SDSZZwX0yodj/7SDydVGUU6a4ybuUuXAlpJacHI/uIJtMmodzjXUUVVJHlZv/p664pztER5Zsd9AiFJ4khoOcQM5v4eg1hxGWyMEuUElzsUGZBGIO/9tDiFBvQrz2Glw+MI=
  file_glob: true
  file: "*.tar.gz"
  skip_cleanup: true
  overwrite: true
  draft: true
  on:
    all_branches: true
    tags: true

notifications:
  email:
    recipients:
      - admin@owent.net
      - owt5008137@live.com
    on_success: never
    on_failure: never
  irc:
    template:
      - "%{repository}/%{branch} (%{commit} - %{author}): %{build_url}: %{message}"
